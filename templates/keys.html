{% extends "base.html" %}

{% block title %}Quản lý khóa - Secure File Transfer{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <h2 class="mb-4">
                <i class="fas fa-key me-2"></i>Quản Lý Khóa RSA
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Khóa RSA</strong>
                        <p class="mb-0">Hệ thống sử dụng cặp khóa RSA để ký số và xác minh tính toàn vẹn của file.</p>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 me-2">Trạng thái khóa:</h5>
                            <div id="keyStatus">
                                {% if user.private_key and user.public_key %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Đã có khóa
                                </span>
                                {% else %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-circle me-1"></i>Chưa có khóa
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <button id="generateBtn" class="btn btn-primary me-2" onclick="generateKeys()">
                            <i class="fas fa-plus-circle me-1"></i>Tạo cặp khóa mới
                        </button>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt me-2"></i>Thông tin bảo mật
                            </h6>
                            <ul class="list-unstyled mb-0">
                                <li><i class="fas fa-check text-success me-2"></i>Khóa được tạo và lưu trữ an toàn</li>
                                <li><i class="fas fa-check text-success me-2"></i>Sử dụng thuật toán RSA</li>
                                <li><i class="fas fa-check text-success me-2"></i>Độ dài khóa: 2048 bit</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    {% if user.private_key and user.public_key %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Khóa công khai</h6>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" value="{{ user.public_key[:32] }}..." readonly>
                                <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ user.public_key }}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Khóa riêng tư</h6>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" value="{{ user.private_key[:32] }}..." readonly>
                                <button class="btn btn-outline-secondary" onclick="copyToClipboard('{{ user.private_key }}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Không chia sẻ khóa riêng tư với bất kỳ ai
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function generateKeys() {
    const generateBtn = document.getElementById('generateBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang tạo khóa...';

    fetch('/generate_keys', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show new keys
            location.reload();
        } else {
            alert('Lỗi: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Đã xảy ra lỗi khi tạo khóa');
    })
    .finally(() => {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Đã sao chép vào clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Không thể sao chép. Vui lòng thử lại.');
    });
}
</script>
{% endblock %}